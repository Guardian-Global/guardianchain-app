âœ… Capsule Audit Log Export (CSV/JSON)
1. Supabase Table (if not already created)
sql
Copy
Edit
create table if not exists capsule_activity_log (
  id uuid primary key default gen_random_uuid(),
  capsule_id uuid not null,
  user_id uuid,
  action text, -- 'viewed', 'shared', 'unlocked', etc.
  metadata jsonb,
  created_at timestamp default now()
);
2. Backend API Endpoint
/server/routes/capsule/exportAudit.ts

ts
Copy
Edit
import express from "express";
import { supabase } from "../../lib/supabaseClient";
import { Parser } from "json2csv";

const router = express.Router();

router.get("/audit/:capsuleId", async (req, res) => {
  const { capsuleId } = req.params;

  const { data, error } = await supabase
    .from("capsule_activity_log")
    .select("*")
    .eq("capsule_id", capsuleId)
    .order("created_at", { ascending: false });

  if (error) {
    return res.status(500).json({ error: "Failed to export audit logs." });
  }

  const format = req.query.format || "json";

  if (format === "csv") {
    const parser = new Parser();
    const csv = parser.parse(data);
    res.header("Content-Type", "text/csv");
    res.attachment(`capsule-${capsuleId}-audit.csv`);
    return res.send(csv);
  }

  res.json(data);
});

export default router;
Then link in server/index.ts:

ts
Copy
Edit
import exportAudit from "./routes/capsule/exportAudit";
app.use("/api/capsule", exportAudit);
âœ… ðŸ“ˆ Capsule Trend Graph By Day
1. Supabase View or SQL Query
sql
Copy
Edit
select 
  capsule_id,
  date_trunc('day', created_at) as day,
  count(*) as interactions
from capsule_activity_log
where capsule_id = '<capsule-id>'
group by capsule_id, day
order by day asc;
You can expose this via a Supabase view or function:

sql
Copy
Edit
create or replace view capsule_daily_interactions as
select 
  capsule_id,
  date_trunc('day', created_at) as day,
  count(*) as interactions
from capsule_activity_log
group by capsule_id, day;
2. React Component
tsx
Copy
Edit
import { LineChart, Line, XAxis, YAxis, Tooltip, ResponsiveContainer } from "recharts";

export default function CapsuleTrendGraph({ trendData }) {
  return (
    <div className="bg-[#0a0a0a] p-6 rounded-xl text-white">
      <h3 className="text-xl font-bold mb-4">ðŸ“ˆ Daily Capsule Interaction Trend</h3>
      <ResponsiveContainer width="100%" height={300}>
        <LineChart data={trendData}>
          <XAxis dataKey="day" stroke="#00ffe1" />
          <YAxis stroke="#00ffe1" />
          <Tooltip />
          <Line type="monotone" dataKey="interactions" stroke="#00ffe1" strokeWidth={2} />
        </LineChart>
      </ResponsiveContainer>
    </div>
  );
}
